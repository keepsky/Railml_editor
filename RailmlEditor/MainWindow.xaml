<Window x:Class="RailmlEditor.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:RailmlEditor" mc:Ignorable="d" Title="MainWindow" Height="450" Width="800" KeyDown="Window_KeyDown">
    <Window.Resources>
        <local:DiffConverter x:Key="DiffConverter"/>
        <local:AngleConverter x:Key="AngleConverter"/>
        <local:AddConverter x:Key="AddConverter"/>
        <!-- <local:BezierConverter x:Key="BezierConverter"/> -->
        <local:SegmentLengthConverter x:Key="SegmentLengthConverter"/>
        <local:TagPositionConverter x:Key="TagPos"/>
        <local:MidPointConverter x:Key="MidPoint"/>
        <local:ReadableAngleConverter x:Key="ReadableAngle"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <!-- Grid Background Brush (10px dots) -->
        <!-- Fix: Set Viewbox="0,0,10,10" Absolute to prevent stretching the 1px rect to fill the tile -->
        <DrawingBrush x:Key="GridBackgroundBrush" Viewbox="0,0,10,10" ViewboxUnits="Absolute" Viewport="0,0,10,10" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#D3D3D3">
                    <GeometryDrawing.Geometry>
                        <!-- Smallest size: 1x1 pixel square -->
                        <RectangleGeometry Rect="0,0,1,1"/>
                    </GeometryDrawing.Geometry>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <!-- Data Templates for Visual Elements -->
        <DataTemplate DataType="{x:Type local:ViewModels.TrackViewModel}">
            <Canvas>
                <!-- Track Visual (Rotated Rectangle) -->
                <!-- Use native RadiusX/Y to prevent distortion. Width = Length + 10 (5px each side). Offset X=-5. -->
                <Rectangle Height="10" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="5" RadiusY="5">
                    <Rectangle.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Flip Horizontally (좌우반전)" Command="{Binding FlipHorizontallyCommand}"/>
                        </ContextMenu>
                    </Rectangle.ContextMenu>
                    <Rectangle.Width>
                        <Binding Path="Length" Converter="{StaticResource AddConverter}" ConverterParameter="10"/>
                    </Rectangle.Width>
                    <Rectangle.RenderTransform>
                        <TransformGroup>
                            <TranslateTransform X="-5" Y="-5"/>
                            <RotateTransform>
                                <RotateTransform.Angle>
                                    <MultiBinding Converter="{StaticResource AngleConverter}">
                                        <Binding Path="X"/>
                                        <Binding Path="Y"/>
                                        <Binding Path="X2"/>
                                        <Binding Path="Y2"/>
                                    </MultiBinding>
                                </RotateTransform.Angle>
                            </RotateTransform>
                        </TransformGroup>
                    </Rectangle.RenderTransform>
                </Rectangle>

                <!-- Start Thumb -->
                <Thumb DragDelta="StartThumb_DragDelta" DragStarted="Thumb_DragStarted" DragCompleted="Thumb_DragCompleted" Canvas.Left="-6" Canvas.Top="-6" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <Thumb.Template>
                        <ControlTemplate>
                            <Ellipse Width="12" Height="12" Fill="Red" Stroke="White" StrokeThickness="1"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <!-- End Thumb -->
                <Thumb DragDelta="EndThumb_DragDelta" DragStarted="Thumb_DragStarted" DragCompleted="Thumb_DragCompleted" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="X2"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="Y2"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <Thumb.RenderTransform>
                        <TranslateTransform X="-6" Y="-6"/>
                    </Thumb.RenderTransform>
                    <Thumb.Template>
                        <ControlTemplate>
                            <Ellipse Width="12" Height="12" Fill="Blue" Stroke="White" StrokeThickness="1"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <!-- Track Name Display (6px, perfectly centered horizontally) -->
                <Grid>
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource MidPoint}">
                            <Binding Path="X2"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource MidPoint}">
                            <Binding Path="Y2"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <TextBlock Text="{Binding Name}" FontSize="6" Foreground="Black" Width="200" TextAlignment="Center" Margin="-100,-4,0,0"/>
                </Grid>
            </Canvas>
        </DataTemplate>
        <DataTemplate DataType="{x:Type local:ViewModels.SwitchViewModel}">
            <Canvas>
                <!-- Point Tag Image (ptag.svg) -->
                <!-- Scaled to 0.5x (130x40). Circle center at (20,20). -->
                <!-- Position: Top=5px, Left aligned such that circle center is at switch X (0). -->
                <!-- So Left = -20. -->
                <!-- Scaled to Height 12px (Original 80px). Scale 0.15. -->
                <!-- Scaled to Height 12px (Original 82px). Scale 0.146. -->
                <!-- Width 35.4px (Original 242px). -->
                <!-- User requested X = -15. Y = 7. -->
                <Grid Width="35" Height="12" MouseLeftButtonDown="Tag_MouseLeftButtonDown" MouseMove="Tag_MouseMove" MouseLeftButtonUp="Tag_MouseLeftButtonUp">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource TagPos}" ConverterParameter="X">
                            <Binding Path="MX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource TagPos}" ConverterParameter="Y">
                            <Binding Path="MY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <!-- Replaced SVG Image with XAML Vector Graphics due to lack of native SVG support -->
                    <Viewbox Stretch="Uniform">
                        <Canvas Width="242" Height="82">
                            <!-- Right Rounded Rectangle (x=81, y=1, w=160, h=80) -->
                            <Rectangle Canvas.Left="81" Canvas.Top="1" Width="160" Height="80" RadiusX="32" RadiusY="32" Fill="White" Stroke="Black" StrokeThickness="5"/>
                            <!-- Left Circle (cx=31, cy=41, r=30 -> x=1, y=11, w=60, h=60) -->
                            <Ellipse Canvas.Left="1" Canvas.Top="11" Width="60" Height="60" Fill="White" Stroke="Black" StrokeThickness="5"/>
                        </Canvas>
                    </Viewbox>

                    <!-- Text Name in Right Round Box -->
                    <!-- Box starts at 81 * 0.146 = 11.8px. Width 160 * 0.146 = 23.4px. -->
                    <TextBlock Text="{Binding Name}" Margin="12,0,0,0" Width="23" VerticalAlignment="Center" HorizontalAlignment="Center" TextAlignment="Center" Foreground="Black" FontWeight="Bold" FontSize="10"/>
                </Grid>

                <!-- Selecting Logic Aid (Transparent Hit Box around center?) -->
                <!-- Switch logic uses 5px radius. Let's add a small transparent circle for hitting if needed? -->
                <!-- User didn't ask for hit test visual, but dragging requires hitting. -->
                <!-- If I add this large tag, hitting the tag will select the switch. -->
                <!-- That is good. -->
            </Canvas>
        </DataTemplate>
        <!-- Signal Icon Template -->
        <ControlTemplate x:Key="SignalIcon">
            <Viewbox Stretch="Uniform">
                <Canvas Width="110" Height="53">
                    <!-- Red Head -->
                    <Ellipse Canvas.Left="58" Canvas.Top="1" Width="50" Height="50" Fill="#FF0000" Stroke="Black" StrokeThickness="3"/>
                    <!-- Horizontal Line -->
                    <Path Data="M 3 26 L 58 26" Stroke="Black" StrokeThickness="6"/>
                    <!-- Vertical Line (Base) -->
                    <Path Data="M 3 7.25 L 3 44.75" Stroke="Black" StrokeThickness="6"/>
                    <!-- White Circle -->
                    <Ellipse Canvas.Left="13" Canvas.Top="11" Width="30" Height="30" Fill="White" Stroke="Black" StrokeThickness="3"/>
                </Canvas>
            </Viewbox>
        </ControlTemplate>

        <!-- Point Icon Template (from point.svg) -->
        <ControlTemplate x:Key="PointIcon">
            <Viewbox Stretch="Uniform">
                <Canvas Width="320" Height="177">
                    <!-- Rect 2 (Bottom) -->
                    <Rectangle Canvas.Left="0" Canvas.Top="129" Width="320" Height="40" RadiusX="20" RadiusY="20" Fill="#B3B3B3"/>
                    <!-- Rect 3 (Top Right) -->
                    <Rectangle Canvas.Left="166" Canvas.Top="8" Width="154" Height="40" RadiusX="20" RadiusY="20" Fill="#B3B3B3"/>
                    <!-- Rect 1 (Diagonal) -->
                    <Rectangle Canvas.Left="20" Canvas.Top="68.32" Width="210" Height="40" RadiusX="20" RadiusY="20" Fill="#B3B3B3" RenderTransformOrigin="0.5,0.5">
                        <Rectangle.RenderTransform>
                            <RotateTransform Angle="-45"/>
                        </Rectangle.RenderTransform>
                    </Rectangle>
                </Canvas>
            </Viewbox>
        </ControlTemplate>

        <DataTemplate DataType="{x:Type local:ViewModels.SignalViewModel}">
            <!-- Fixed Layout Grid: Matches Icon Size (20x10) -->
            <!-- ClipToBounds="False" is CRITICAL because text is positioned outside (negative coordinates) -->
            <Grid Width="20" Height="10" ClipToBounds="False">

                <!-- Icon (Centered in Grid) -->
                <!-- Note: Flipped Icon translates to X=-20, occupying -20..0 visual space -->
                <Control Template="{StaticResource SignalIcon}" Width="20" Height="10" RenderTransformOrigin="0.5,0.5">
                    <Control.Style>
                        <Style TargetType="Control">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsFlipped}" Value="True">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TransformGroup>
                                                <ScaleTransform ScaleX="-1" ScaleY="1"/>
                                                <TranslateTransform X="-20"/>
                                            </TransformGroup>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Control.Style>
                </Control>

                <!-- Left Text: Direction Up -->
                <!-- Aligns Right Edge to Grid Left (0) with 2px gap -->
                <!-- Use RenderTransform instead of Margin to avoid layout collapse (20px width - 22px margin < 0) -->
                <!-- Align Right (at 20). Translate -22 -> Right Edge at -2. -->
                <TextBlock Text="{Binding Name}" FontSize="8" VerticalAlignment="Center" HorizontalAlignment="Right">
                    <TextBlock.RenderTransform>
                        <TranslateTransform X="-22"/>
                    </TextBlock.RenderTransform>
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Direction}" Value="up">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Right Text: Direction Down -->
                <!-- Aligns Left Edge to Grid Left (0) -->
                <!-- Flipped Icon is at -20..0. Text starts at 0. -->
                <!-- HorizontalAlignment="Left" -> Left Edge at 0. -->
                <!-- Margin Left="0" -> X=0. -->
                <TextBlock Text="{Binding Name}" FontSize="8" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="0,0,0,0">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Direction}" Value="down">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

            </Grid>
        </DataTemplate>
        <DataTemplate DataType="{x:Type local:ViewModels.CurvedTrackViewModel}">
            <Canvas>
                <!-- Segment 1: Start to Mid -->
                <!-- Width = Dist(X,Y, MX,MY) + 10. Rotate = Angle(X,Y, MX,MY). Translate -5,-5. -->
                <Rectangle Height="10" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="5" RadiusY="5">
                    <Rectangle.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Flip Horizontally (좌우반전)" Command="{Binding FlipHorizontallyCommand}"/>
                            <MenuItem Header="Flip Vertically (상하반전)" Command="{Binding FlipVerticallyCommand}"/>
                        </ContextMenu>
                    </Rectangle.ContextMenu>
                    <Rectangle.Width>
                        <MultiBinding Converter="{StaticResource SegmentLengthConverter}" ConverterParameter="10">
                            <Binding Path="X"/>
                            <Binding Path="Y"/>
                            <Binding Path="MX"/>
                            <Binding Path="MY"/>
                        </MultiBinding>
                    </Rectangle.Width>
                    <Rectangle.RenderTransform>
                        <TransformGroup>
                            <TranslateTransform X="-5" Y="-5"/>
                            <RotateTransform>
                                <RotateTransform.Angle>
                                    <MultiBinding Converter="{StaticResource AngleConverter}">
                                        <Binding Path="X"/>
                                        <Binding Path="Y"/>
                                        <Binding Path="MX"/>
                                        <Binding Path="MY"/>
                                    </MultiBinding>
                                </RotateTransform.Angle>
                            </RotateTransform>
                        </TransformGroup>
                    </Rectangle.RenderTransform>
                </Rectangle>

                <!-- Segment 2: Mid to End -->
                <!-- Positioned at relative (MX - X, MY - Y). -->
                <Rectangle Height="10" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="5" RadiusY="5">
                    <Rectangle.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Flip Horizontally (좌우반전)" Command="{Binding FlipHorizontallyCommand}"/>
                            <MenuItem Header="Flip Vertically (상하반전)" Command="{Binding FlipVerticallyCommand}"/>
                        </ContextMenu>
                    </Rectangle.ContextMenu>
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="MX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="MY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <Rectangle.Width>
                        <MultiBinding Converter="{StaticResource SegmentLengthConverter}" ConverterParameter="10">
                            <Binding Path="MX"/>
                            <Binding Path="MY"/>
                            <Binding Path="X2"/>
                            <Binding Path="Y2"/>
                        </MultiBinding>
                    </Rectangle.Width>
                    <Rectangle.RenderTransform>
                        <TransformGroup>
                            <TranslateTransform X="-5" Y="-5"/>
                            <RotateTransform>
                                <RotateTransform.Angle>
                                    <MultiBinding Converter="{StaticResource AngleConverter}">
                                        <Binding Path="MX"/>
                                        <Binding Path="MY"/>
                                        <Binding Path="X2"/>
                                        <Binding Path="Y2"/>
                                    </MultiBinding>
                                </RotateTransform.Angle>
                            </RotateTransform>
                        </TransformGroup>
                    </Rectangle.RenderTransform>
                </Rectangle>

                <!-- Start Thumb -->
                <Thumb DragDelta="StartThumb_DragDelta" DragStarted="Thumb_DragStarted" DragCompleted="Thumb_DragCompleted" Canvas.Left="-6" Canvas.Top="-6" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <Thumb.Template>
                        <ControlTemplate>
                            <Ellipse Width="12" Height="12" Fill="Red" Stroke="White" StrokeThickness="1"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <!-- Mid Thumb (Relative Position) -->
                <Thumb DragDelta="MidThumb_DragDelta" DragStarted="Thumb_DragStarted" DragCompleted="Thumb_DragCompleted" Canvas.Left="-6" Canvas.Top="-6" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <!-- Translate by MX - X, MY - Y -->
                    <Thumb.RenderTransform>
                        <TranslateTransform>
                            <TranslateTransform.X>
                                <MultiBinding Converter="{StaticResource DiffConverter}">
                                    <Binding Path="MX"/>
                                    <Binding Path="X"/>
                                </MultiBinding>
                            </TranslateTransform.X>
                            <TranslateTransform.Y>
                                <MultiBinding Converter="{StaticResource DiffConverter}">
                                    <Binding Path="MY"/>
                                    <Binding Path="Y"/>
                                </MultiBinding>
                            </TranslateTransform.Y>
                        </TranslateTransform>
                    </Thumb.RenderTransform>
                    <Thumb.Template>
                        <ControlTemplate>
                            <Ellipse Width="10" Height="10" Fill="Green" Stroke="White" StrokeThickness="1"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <!-- End Thumb -->
                <Thumb DragDelta="EndThumb_DragDelta" DragStarted="Thumb_DragStarted" DragCompleted="Thumb_DragCompleted" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="X2"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource DiffConverter}">
                            <Binding Path="Y2"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <Thumb.RenderTransform>
                        <TranslateTransform X="-6" Y="-6"/>
                    </Thumb.RenderTransform>
                    <Thumb.Template>
                        <ControlTemplate>
                            <Ellipse Width="12" Height="12" Fill="Blue" Stroke="White" StrokeThickness="1"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <!-- Track Name Display (6px, centered at Mid point of 1st segment and upright-rotated) -->
                <Grid>
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource MidPoint}">
                            <Binding Path="MX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource MidPoint}">
                            <Binding Path="MY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <TextBlock Text="{Binding Name}" FontSize="6" Foreground="Black" Width="200" TextAlignment="Center" Margin="-100,-4,0,0" RenderTransformOrigin="0.5,0.5">
                        <TextBlock.RenderTransform>
                            <RotateTransform>
                                <RotateTransform.Angle>
                                    <MultiBinding Converter="{StaticResource ReadableAngle}">
                                        <Binding Path="X"/>
                                        <Binding Path="Y"/>
                                        <Binding Path="MX"/>
                                        <Binding Path="MY"/>
                                    </MultiBinding>
                                </RotateTransform.Angle>
                            </RotateTransform>
                        </TextBlock.RenderTransform>
                    </TextBlock>
                </Grid>
            </Canvas>
        </DataTemplate>
        <Style x:Key="ToolBarButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="36"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#FFFFFF" Offset="0.0"/>
                        <GradientStop Color="#F0F0F0" Offset="0.5"/>
                        <GradientStop Color="#E0E0E0" Offset="1.0"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="BorderBrush" Value="#A0A0A0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Style.Resources>
                <Style TargetType="Border">
                    <Setter Property="CornerRadius" Value="3"/>
                </Style>
            </Style.Resources>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background">
                        <Setter.Value>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="#F0F0F0" Offset="0.0"/>
                                <GradientStop Color="#E0E0E0" Offset="1.0"/>
                            </LinearGradientBrush>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="BorderBrush" Value="#007ACC"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#D0D0D0"/>
                    <Setter Property="Padding" Value="3,3,1,1"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="File">
                <MenuItem Header="Open..." Click="FileOpen_Click"/>
                <MenuItem Header="Save..." Click="FileSave_Click"/>
                <Separator/>
                <MenuItem Header="Exit" Click="FileExit_Click"/>
            </MenuItem>
            <MenuItem Header="Edit" />
            <MenuItem Header="View" />
        </Menu>

        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <Button Click="Toolbox_Click" ToolTip="Track" Style="{StaticResource ToolBarButtonStyle}">
                    <!-- Track Icon using Rectangle -->
                    <Rectangle Width="24" Height="4" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="2" RadiusY="2"/>
                    <Button.Tag>Track</Button.Tag>
                </Button>
                <!-- Switch Button REMOVED -->
                <Button Click="Toolbox_Click" ToolTip="Signal" Style="{StaticResource ToolBarButtonStyle}">
                    <!-- Signal Icon using ControlTemplate -->
                    <Control Template="{StaticResource SignalIcon}" Width="28" Height="14"/>
                    <Button.Tag>Signal</Button.Tag>
                </Button>
                <Button Click="Toolbox_Click" ToolTip="Point" Style="{StaticResource ToolBarButtonStyle}">
                    <!-- Point Icon from point.svg -->
                    <Control Template="{StaticResource PointIcon}" Width="28" Height="16"/>
                    <Button.Tag>CurvedTrack</Button.Tag>
                </Button>
            </ToolBar>
        </ToolBarTray>

        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem Content="Ready"/>
        </StatusBar>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="150"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Properties Panel (Moved to Left) -->
            <!-- Left Pane: Tree View and Properties -->
            <Grid Grid.Column="0" Background="#F0F0F0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Tree View -->
                <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0,0,1,1" Margin="0,0,0,5">
                    <DockPanel>
                        <TextBlock Text="Explorer" DockPanel.Dock="Top" FontWeight="Bold" Margin="5"/>
                        <TreeView ItemsSource="{Binding TreeCategories}" BorderThickness="0" Background="Transparent" Name="ElementTree">
                            <TreeView.ItemTemplate>
                                <HierarchicalDataTemplate ItemsSource="{Binding Items}">
                                    <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                                    <HierarchicalDataTemplate.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Id}"/>
                                                <TextBlock Text=" - " Foreground="Gray"/>
                                                <TextBlock Text="{Binding Name}" Foreground="Gray" FontStyle="Italic"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </HierarchicalDataTemplate.ItemTemplate>
                                </HierarchicalDataTemplate>
                            </TreeView.ItemTemplate>
                            <TreeView.ItemContainerStyle>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="IsExpanded" Value="True"/>
                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                        </TreeView>
                    </DockPanel>
                </Border>

                <!-- Splitter -->
                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" Background="LightGray"/>

                <!-- Properties Panel -->
                <Border Grid.Row="2" BorderBrush="Gray" BorderThickness="0,1,1,0" Padding="5">
                    <DockPanel>
                        <TextBlock Text="Properties" DockPanel.Dock="Top" FontWeight="Bold" Margin="0,0,0,10"/>
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ContentControl Content="{Binding SelectedElement}" Grid.IsSharedSizeScope="True">
                                <ContentControl.Resources>
                                    <Style TargetType="TextBlock" x:Key="PropLabel">
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="Margin" Value="0,0,10,5"/>
                                    </Style>
                                    <Style TargetType="TextBox" x:Key="PropValue">
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="Margin" Value="0,0,0,5"/>
                                    </Style>

                                    <!-- Track Properties -->
                                    <DataTemplate DataType="{x:Type local:ViewModels.TrackViewModel}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="PropLabel"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Text="ID" Grid.Row="0" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Id, Mode=OneWay}" IsReadOnly="True" Grid.Row="0" Grid.Column="1" Style="{StaticResource PropValue}" Foreground="Gray"/>

                                            <TextBlock Text="Name" Grid.Row="1" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Description" Grid.Row="2" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Type" Grid.Row="3" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableTypes}" SelectedItem="{Binding Type, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="MainDir" Grid.Row="4" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableMainDirs}" SelectedItem="{Binding MainDir, UpdateSourceTrigger=PropertyChanged}" Grid.Row="4" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="Length" Grid.Row="5" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Length, Mode=OneWay, StringFormat=N2}" IsReadOnly="True" Grid.Row="5" Grid.Column="1" Style="{StaticResource PropValue}" Foreground="Gray"/>

                                            <Separator Grid.Row="6" Grid.ColumnSpan="2" Margin="0,10"/>

                                            <TextBlock Text="Begin X" Grid.Row="7" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Grid.Row="7" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Begin Y" Grid.Row="8" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Grid.Row="8" Grid.Column="1" Style="{StaticResource PropValue}"/>
                                        </Grid>
                                    </DataTemplate>

                                    <!-- Curved Track Properties -->
                                    <DataTemplate DataType="{x:Type local:ViewModels.CurvedTrackViewModel}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="PropLabel"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Text="ID" Grid.Row="0" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Id, Mode=OneWay}" IsReadOnly="True" Grid.Row="0" Grid.Column="1" Style="{StaticResource PropValue}" Foreground="Gray"/>

                                            <TextBlock Text="Name" Grid.Row="1" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Description" Grid.Row="2" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Type" Grid.Row="3" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableTypes}" SelectedItem="{Binding Type, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="MainDir" Grid.Row="4" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableMainDirs}" SelectedItem="{Binding MainDir, UpdateSourceTrigger=PropertyChanged}" Grid.Row="4" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="Length" Grid.Row="5" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Length, Mode=OneWay, StringFormat=N2}" IsReadOnly="True" Grid.Row="5" Grid.Column="1" Style="{StaticResource PropValue}" Foreground="Gray"/>

                                            <Separator Grid.Row="6" Grid.ColumnSpan="2" Margin="0,10"/>

                                            <TextBlock Text="Begin X" Grid.Row="7" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Grid.Row="7" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Begin Y" Grid.Row="8" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Grid.Row="8" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Mid X" Grid.Row="9" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding MX, UpdateSourceTrigger=PropertyChanged}" Grid.Row="9" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Mid Y" Grid.Row="10" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding MY, UpdateSourceTrigger=PropertyChanged}" Grid.Row="10" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="End X" Grid.Row="11" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding X2, UpdateSourceTrigger=PropertyChanged}" Grid.Row="11" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="End Y" Grid.Row="12" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Y2, UpdateSourceTrigger=PropertyChanged}" Grid.Row="12" Grid.Column="1" Style="{StaticResource PropValue}"/>
                                        </Grid>
                                    </DataTemplate>

                                    <!-- Switch Properties -->
                                    <DataTemplate DataType="{x:Type local:ViewModels.SwitchViewModel}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="PropLabel"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Text="ID" Grid.Row="0" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Id, Mode=OneWay}" IsReadOnly="True" Grid.Row="0" Grid.Column="1" Style="{StaticResource PropValue}" Foreground="Gray"/>

                                            <TextBlock Text="Name" Grid.Row="1" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Pos X" Grid.Row="2" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Pos Y" Grid.Row="3" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Style="{StaticResource PropValue}"/>
                                        </Grid>
                                    </DataTemplate>

                                    <!-- Signal Properties -->
                                    <DataTemplate DataType="{x:Type local:ViewModels.SignalViewModel}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="PropLabel"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Text="ID" Grid.Row="0" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Id}" Grid.Row="0" Grid.Column="1" Style="{StaticResource PropValue}" IsReadOnly="True"/>

                                            <TextBlock Text="Name" Grid.Row="1" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Type" Grid.Row="2" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableTypes}" SelectedItem="{Binding Type, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="Function" Grid.Row="3" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableFunctions}" SelectedItem="{Binding Function, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="Direction" Grid.Row="4" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <ComboBox ItemsSource="{Binding AvailableDirections}" SelectedItem="{Binding Direction, UpdateSourceTrigger=PropertyChanged}" Grid.Row="4" Grid.Column="1" Margin="0,0,0,5" VerticalAlignment="Center"/>

                                            <TextBlock Text="X" Grid.Row="5" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding X}" Grid.Row="5" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Y" Grid.Row="6" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding Y}" Grid.Row="6" Grid.Column="1" Style="{StaticResource PropValue}"/>

                                            <TextBlock Text="Bind Track" Grid.Row="7" Grid.Column="0" Style="{StaticResource PropLabel}"/>
                                            <TextBox Text="{Binding RelatedTrackId}" Grid.Row="7" Grid.Column="1" Style="{StaticResource PropValue}" IsReadOnly="True"/>
                                        </Grid>
                                    </DataTemplate>

                                </ContentControl.Resources>
                            </ContentControl>
                        </ScrollViewer>
                    </DockPanel>
                </Border>
            </Grid>

            <!-- Grid Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="LightGray"/>

            <!-- Main Canvas Area -->
            <Grid Grid.Column="2" x:Name="MainGrid" Background="Transparent" MouseDown="MainGrid_MouseDown" MouseMove="MainGrid_MouseMove" MouseUp="MainGrid_MouseUp" Focusable="True" KeyDown="MainGrid_KeyDown">
                <ScrollViewer x:Name="MainScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                    <ItemsControl x:Name="MainDesigner" ItemsSource="{Binding Elements}" Background="{StaticResource GridBackgroundBrush}" Width="2000" Height="2000" AllowDrop="True" Drop="MainDesigner_Drop">
                        <ItemsControl.LayoutTransform>
                            <ScaleTransform x:Name="MainScaleTransform" ScaleX="1" ScaleY="1"/>
                        </ItemsControl.LayoutTransform>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                <Setter Property="Opacity" Value="{Binding IsSelected, Converter={local:BoolToOpacityConverter}}"/>
                                <EventSetter Event="MouseDown" Handler="Item_MouseDown"/>
                                <EventSetter Event="MouseMove" Handler="Item_MouseMove"/>
                                <EventSetter Event="MouseUp" Handler="Item_MouseUp"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ContentPresenter Content="{Binding}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
                <Canvas x:Name="OverlayCanvas" IsHitTestVisible="False">
                    <Rectangle x:Name="SelectionBox" Stroke="#007ACC" StrokeDashArray="2 2" StrokeThickness="1" Fill="#33007ACC" Visibility="Collapsed"/>
                </Canvas>
            </Grid>


        </Grid>
    </DockPanel>
</Window>
