<Window x:Class="RailmlEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:RailmlEditor"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <Window.Resources>
        <local:DiffConverter x:Key="DiffConverter"/>
        <local:AngleConverter x:Key="AngleConverter"/>
        <local:AddConverter x:Key="AddConverter"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        
        <!-- Data Templates for Visual Elements -->
        <DataTemplate DataType="{x:Type local:ViewModels.TrackViewModel}">
            <Canvas>
                 <!-- Track Visual (Rotated Rectangle) -->
                 <!-- Use native RadiusX/Y to prevent distortion. Width = Length + 10 (5px each side). Offset X=-5. -->
                 <Rectangle Height="10" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="5" RadiusY="5">
                     <Rectangle.Width>
                         <Binding Path="Length" Converter="{StaticResource AddConverter}" ConverterParameter="10"/>
                     </Rectangle.Width>
                     <Rectangle.RenderTransform>
                         <TransformGroup>
                             <TranslateTransform X="-5" Y="-5"/>
                             <RotateTransform>
                                 <RotateTransform.Angle>
                                     <MultiBinding Converter="{StaticResource AngleConverter}">
                                         <Binding Path="X"/>
                                         <Binding Path="Y"/>
                                         <Binding Path="X2"/>
                                         <Binding Path="Y2"/>
                                     </MultiBinding>
                                 </RotateTransform.Angle>
                             </RotateTransform>
                         </TransformGroup>
                     </Rectangle.RenderTransform>
                 </Rectangle>

                 <!-- Start Thumb -->
                 <Thumb DragDelta="StartThumb_DragDelta" DragStarted="Thumb_DragStarted" Canvas.Left="-6" Canvas.Top="-6"
                        Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                     <Thumb.Template>
                         <ControlTemplate>
                             <Ellipse Width="12" Height="12" Fill="Red" Stroke="White" StrokeThickness="1"/>
                         </ControlTemplate>
                     </Thumb.Template>
                 </Thumb>
                 
                 <!-- End Thumb -->
                 <Thumb DragDelta="EndThumb_DragDelta" DragStarted="Thumb_DragStarted"
                        Visibility="{Binding IsSelected, Converter={StaticResource BoolToVis}}">
                    <Canvas.Left>
                         <MultiBinding Converter="{StaticResource DiffConverter}">
                             <Binding Path="X2"/>
                             <Binding Path="X"/>
                         </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                         <MultiBinding Converter="{StaticResource DiffConverter}">
                             <Binding Path="Y2"/>
                             <Binding Path="Y"/>
                         </MultiBinding>
                    </Canvas.Top>
                     <Thumb.RenderTransform>
                        <TranslateTransform X="-6" Y="-6"/>
                     </Thumb.RenderTransform>
                     <Thumb.Template>
                         <ControlTemplate>
                             <Ellipse Width="12" Height="12" Fill="Blue" Stroke="White" StrokeThickness="1"/>
                         </ControlTemplate>
                     </Thumb.Template>
                 </Thumb>
            </Canvas>
        </DataTemplate>
        <DataTemplate DataType="{x:Type local:ViewModels.SwitchViewModel}">
            <Polygon Points="0,0 40,0 20,20 0,0" Fill="Orange" Stroke="Black" StrokeThickness="1"/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type local:ViewModels.SignalViewModel}">
            <Ellipse Width="15" Height="15" Fill="Red" Stroke="DarkRed" StrokeThickness="1"/>
        </DataTemplate>
    </Window.Resources>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="File">
                <MenuItem Header="Open..." Click="FileOpen_Click"/>
                <MenuItem Header="Save..." Click="FileSave_Click"/>
                <Separator/>
                <MenuItem Header="Exit" Click="FileExit_Click"/>
            </MenuItem>
            <MenuItem Header="Edit" />
            <MenuItem Header="View" />
        </Menu>
        
        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <Button Click="Toolbox_Click" ToolTip="Track">
                    <!-- Track Icon using Rectangle -->
                    <Rectangle Width="30" Height="6" Fill="White" Stroke="Black" StrokeThickness="1" RadiusX="3" RadiusY="3"/>
                    <Button.Tag>Track</Button.Tag>
                </Button>
                <Button Click="Toolbox_Click" ToolTip="Switch">
                    <!-- Switch Icon using Polygon -->
                     <Polygon Points="0,0 20,0 10,10 0,0" Fill="Orange" Stroke="Black" StrokeThickness="1" Stretch="Uniform" Width="20" Height="20"/>
                     <Button.Tag>Switch</Button.Tag>
                </Button>
                <Button Click="Toolbox_Click" ToolTip="Signal">
                    <!-- Signal Icon using Ellipse -->
                    <Ellipse Width="15" Height="15" Fill="Red" Stroke="DarkRed" StrokeThickness="1"/>
                    <Button.Tag>Signal</Button.Tag>
                </Button>
            </ToolBar>
        </ToolBarTray>

        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem Content="Ready"/>
        </StatusBar>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="150"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

             <!-- Properties Panel (Moved to Left) -->
            <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0,0,1,0" Background="#F0F0F0">
                <StackPanel Margin="10">
                    <TextBlock Text="Properties" FontWeight="Bold" Margin="0,0,0,10"/>
                    <!-- Simple Property Grid for now -->
                    <ContentControl Content="{Binding SelectedElement}">
                        <ContentControl.Resources>
                            <!-- Track Properties -->
                            <DataTemplate DataType="{x:Type local:ViewModels.TrackViewModel}">
                                <StackPanel>
                                    <TextBlock Text="Type: Track" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBlock Text="ID:"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                    
                                    <Separator Margin="0,10"/>
                                    <TextBlock Text="Start Point (Begin)" FontWeight="SemiBold"/>
                                    <TextBlock Text="X:"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="Y:"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}"/>
                                    
                                    <Separator Margin="0,10"/>
                                    <TextBlock Text="End Point (End)" FontWeight="SemiBold"/>
                                    <TextBlock Text="X2:"/>
                                    <TextBox Text="{Binding X2, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="Y2:"/>
                                    <TextBox Text="{Binding Y2, UpdateSourceTrigger=PropertyChanged}"/>
                                </StackPanel>
                            </DataTemplate>

                            <!-- Switch Properties -->
                            <DataTemplate DataType="{x:Type local:ViewModels.SwitchViewModel}">
                                <StackPanel>
                                    <TextBlock Text="Type: Switch" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBlock Text="ID:"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="X:"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="Y:"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}"/>
                                </StackPanel>
                            </DataTemplate>

                            <!-- Signal Properties -->
                            <DataTemplate DataType="{x:Type local:ViewModels.SignalViewModel}">
                                <StackPanel>
                                    <TextBlock Text="Type: Signal" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBlock Text="ID:"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="X:"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}"/>
                                    <TextBlock Text="Y:"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.Resources>
                    </ContentControl>
                </StackPanel>
            </Border>

            <!-- Grid Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="LightGray"/>

            <!-- Main Canvas Area -->
            <Grid Grid.Column="2" x:Name="MainGrid" Background="Transparent"
                  MouseDown="MainGrid_MouseDown" 
                  MouseMove="MainGrid_MouseMove" 
                  MouseUp="MainGrid_MouseUp"
                  Focusable="True"
                  KeyDown="MainGrid_KeyDown">
                <ScrollViewer x:Name="MainScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="MainDesigner" 
                              ItemsSource="{Binding Elements}" 
                              Background="White" Width="2000" Height="2000"
                              AllowDrop="True"
                              Drop="MainDesigner_Drop">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            <Setter Property="Opacity" Value="{Binding IsSelected, Converter={local:BoolToOpacityConverter}}"/> 
                            <EventSetter Event="MouseDown" Handler="Item_MouseDown"/>
                            <EventSetter Event="MouseMove" Handler="Item_MouseMove"/>
                            <EventSetter Event="MouseUp" Handler="Item_MouseUp"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
            <Canvas x:Name="OverlayCanvas" IsHitTestVisible="False">
                <Rectangle x:Name="SelectionBox" Stroke="#007ACC" StrokeDashArray="2 2" StrokeThickness="1" Fill="#33007ACC" Visibility="Collapsed"/>
            </Canvas>
            </Grid>


        </Grid>
    </DockPanel>
</Window>
